@page "/EpicForPanel/{panelId:int}"
@using System.Security.Cryptography.Xml
@using TaskPanelLibrary.Entity
@using TaskPanelLibrary.Service
@using TaskPanelLibrary.Service.Interface
@inject IEpicService EpicService
@inject NavigationManager NavigationManager
@inject IAuthService AuthService

<h1 class="text-left text-dark font-weight-bold display-4 mb-4">Epics for Panel</h1>

@if (epics.Any())
{
    <h3 class="mt-5 text-success">Active Epics</h3>
    <table class="table table-bordered table-hover mt-3 shadow-sm rounded bg-white">
        <thead class="thead-light">
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Priority</th>
            <th>Due Date</th>
            <th class="text-center">Actions</th>
            <th class="text-center">Tasks Management</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var epic in epics)
        {
            <tr @onclick="() => NavigateToTasksForEpic(epic.Id)" style="cursor: pointer;" class="selectable-row">
                <td>@epic.Title</td>
                <td>@epic.Description</td>
                <td>@epic.Priority</td>
                <td>@epic.DueDateTime.ToShortDateString()</td>
                <td class="text-center">
                    <button class="btn btn-outline-warning btn-sm mr-2" @onclick:stopPropagation="true" @onclick="() => UpdateEpic(epic.Id)">Update</button>
                    <button class="btn btn-outline-danger btn-sm mr-2" @onclick:stopPropagation="true" @onclick="() => DeleteEpic(epic.Id)">Delete</button>
                </td>
                <td class="text-center">
                    <button class="btn btn-outline-info btn-sm" @onclick:stopPropagation="true" @onclick="() => ManageTasksForEpic(epic.Id)">Manage Tasks</button>
                    <button class="btn btn-outline-success btn-sm mr-2" @onclick:stopPropagation="true" @onclick="() => NavigateToEpicReport(epic.Id)">View Report</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info mt-4" role="alert">
        No epics available. Please create one.
    </div>
}

<div class="d-flex justify-content-start mt-4">
    <button class="btn btn-primary" @onclick="NavigateToCreateEpic">New Epic</button>
    <button class="btn btn-danger text-white ml-3" style="cursor: pointer; margin-left: 10px;" @onclick="NavigateBackToPanels">Back to Panels</button>
</div>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger mt-4">
        @_errorMessage
    </div>
}

@code {
    [Parameter] public int panelId { get; set; }

    private List<Epic> epics;
    private string _errorMessage;
    private User _user;

    protected override void OnInitialized()
    {
        LoadEpics();
    }

    private void LoadEpics()
    {
        try
        {
            epics = EpicService.GetAllEpicsByPanelId(panelId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading epics: {ex.Message}";
        }
    }

    private void NavigateToCreateEpic()
    {
        NavigationManager.NavigateTo($"/epic/create/{panelId}");
    }

    private void NavigateToEpicReport(int epicId)
    {
        NavigationManager.NavigateTo($"/EpicReport/{epicId}");
    }

    private void NavigateBackToPanels()
    {
        _user = AuthService.GetCurrentUser();
        NavigationManager.NavigateTo($"/panels/user/{_user.Id}");
    }

    private void NavigateToTasksForEpic(int epicId)
    {
        NavigationManager.NavigateTo($"/tasks/epic/{epicId}");
    }

    private void UpdateEpic(int epicId)
    {
        NavigationManager.NavigateTo($"/epic/update/{epicId}");
    }

    private void DeleteEpic(int epicId)
    {
        try
        {
            EpicService.DeleteEpic(epicId);
            LoadEpics();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error deleting epic: {ex.Message}";
        }
    }

    private void ManageTasksForEpic(int epicId)
    {
        NavigationManager.NavigateTo($"/ManageTasksInEpic/{epicId}");
    }

}